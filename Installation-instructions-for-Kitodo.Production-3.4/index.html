
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Installation instructions for Kitodo.Production 3.4 - Kitodo Production Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#contents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kitodo Production Documentation" class="md-header__button md-logo" aria-label="Kitodo Production Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kitodo Production Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Installation instructions for Kitodo.Production 3.4
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kitodo Production Documentation" class="md-nav__button md-logo" aria-label="Kitodo Production Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Kitodo Production Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#contents" class="md-nav__link">
    <span class="md-ellipsis">
      Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-preliminary-steps" class="md-nav__link">
    <span class="md-ellipsis">
      1. Preliminary Steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Preliminary Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1a-check-host-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      1a) Check host configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1b-setup-the-data-partition" class="md-nav__link">
    <span class="md-ellipsis">
      1b) Setup the data partition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-install-software-packages" class="md-nav__link">
    <span class="md-ellipsis">
      2. Install software packages
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-determine-root-distinguished-name" class="md-nav__link">
    <span class="md-ellipsis">
      3. Determine Root Distinguished Name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-install-name-service-switch" class="md-nav__link">
    <span class="md-ellipsis">
      4. Install name service switch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-install-elasticsearch" class="md-nav__link">
    <span class="md-ellipsis">
      5. Install ElasticSearch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-prepare-database" class="md-nav__link">
    <span class="md-ellipsis">
      6. Prepare database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-prepare-ldap-for-samba" class="md-nav__link">
    <span class="md-ellipsis">
      7. Prepare LDAP for Samba
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-samba-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      8. Samba configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-create-program-folders-and-files" class="md-nav__link">
    <span class="md-ellipsis">
      9. Create program folders and files
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-configure-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      10. Configure scripts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-configure-tomcat" class="md-nav__link">
    <span class="md-ellipsis">
      11. Configure Tomcat
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-configure-log-rotation" class="md-nav__link">
    <span class="md-ellipsis">
      12. Configure log rotation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-configuration-in-the-front-end" class="md-nav__link">
    <span class="md-ellipsis">
      13. Configuration in the front end
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13. Configuration in the front end">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#13a-build-the-search-index" class="md-nav__link">
    <span class="md-ellipsis">
      13a) Build the search index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13b-configure-ldap" class="md-nav__link">
    <span class="md-ellipsis">
      13b) Configure LDAP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Installation instructions for Kitodo.Production 3.4</h1>

<h2 id="contents">Contents</h2>
<ol>
<li><a href="#1-preliminary-steps">Preliminary steps</a></li>
<li><a href="#2-install-software-packages">Install software packages</a></li>
<li><a href="#3-determin-root-distinguished-name">Determine Root Distinguished Name</a></li>
<li><a href="#4-install-name-service-switch">Install name service switch</a></li>
<li><a href="#5-install-elasticsearch">Install ElasticSearch</a></li>
<li><a href="#6-prepare-database">Prepare database</a></li>
<li><a href="#7-prepare-ldap-for-samba">Prepare LDAP for Samba</a></li>
<li><a href="#8-configure-samba">Configure Samba</a></li>
<li><a href="#9-create-program-folders-and-files">Create program folders and files</a></li>
<li><a href="#10-configure-scripts">Configure scripts</a></li>
<li><a href="#11-configure-tomcat">Configure Tomcat</a></li>
<li><a href="#12-configure-log-rotation">Configure log rotation</a></li>
<li><a href="#13-visual-configuration">Configuration in the front end</a></li>
</ol>
<h2 id="1-preliminary-steps">1. Preliminary Steps</h2>
<h3 id="1a-check-host-configuration">1a) Check host configuration</h3>
<p>Check before installing with the command</p>
<pre><code>sudo hostname -f
</code></pre>
<p>whether the fully qualified domain name (FQDN) corresponds to the planned server name. This is used during the LDAP installation to form the Root Distinguished Name (RDN) and the basic configuration of the LDAP, which can only be corrected later with great effort. Here the FQDN, eg <code>servername.rz.example.com</code>, should be displayed, not just <code>servername</code>. If not, configure <code>/etc/hostsproperly</code> first.</p>
<h3 id="1b-setup-the-data-partition">1b) Setup the data partition</h3>
<p>Digitisation generates a lot of data. Typically, this data is stored on its own partition, which is likely a network device (eg NAS). With the following command we create a mount point for the data partition as <code>/mnt/data</code>:</p>
<pre><code>sudo mkdir /mnt/data
</code></pre>
<p>The set up of data storage is is highly dependent on the hardware and networks used. If you want to use a data partition, ensure that the data partition is mounted on the specified mount point. Now is a good time to consider whether you would like to set up LVM.</p>
<h2 id="2-install-software-packages">2. Install software packages</h2>
<p>Install Tomcat 9, MySQL, ImageMagick, LDAP incl. Utils, Samba, the Apache web server and the Jakarta Connector with package manager. For the installation you will also need HTTPS support for apt, unzip and the dos2unix tool. During the installation you will be asked for the password for the LDAP server. Production stores the password unencrypted in the database. Don't choose a private/valuable password.</p>
<pre><code class="language-sh">sudo apt-get update
sudo apt-get install tomcat9 mysql-server imagemagick slapd ldap-utils samba apt-transport-https unzip dos2unix
</code></pre>
<h2 id="3-determine-root-distinguished-name">3. Determine Root Distinguished Name</h2>
<p>Using the command</p>
<pre><code>sudo slapcat
</code></pre>
<p>you can view the contents of the LDAP server. The entries are separated by blank lines. Here you will find the generated Root Distinguished Name (RDN) in the entry with the property <code>objectClass:top</code> under the key <code>dn</code>.</p>
<p>If you are setting up a test system that doesn't need a DNS name, use <code>dc=nodomain</code> as the RDN. The LDAP admin user has the Common Name (CN) <code>cn=admin,dc=nodomain</code>. This information is also used in these installation instructions. If you are installing the server on your network, it will say something like <code>dc=rz,dc=example,dc=de</code>. Then use this string instead of <code>dc=nodomain</code> later in the installation instructions.</p>
<h2 id="4-install-name-service-switch">4. Install name service switch</h2>
<p>Now install the Name Service Switch LDAP library:</p>
<pre><code>sudo apt-get install libnss-ldap
</code></pre>
<p>During the installation you will be asked for some settings:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LDAP server Uniform Resource Identifier:</strong></td>
<td>ldapi:///</td>
</tr>
<tr>
<td><strong>LDAP search base:</strong></td>
<td>ou=users,dc=nodomain</td>
</tr>
<tr>
<td><strong>LDAP version:</strong></td>
<td>3</td>
</tr>
<tr>
<td><strong>Make local root database admin:</strong></td>
<td>No</td>
</tr>
<tr>
<td><strong>Does the LDAP server require login?</strong></td>
<td>No</td>
</tr>
</tbody>
</table>
<p>If you want or have to repeat this step, enter the following two commands one after the other:</p>
<pre><code>sudo apt-get purge libnss-ldap
sudo apt-get install libnss-ldap
</code></pre>
<h2 id="5-install-elasticsearch">5. Install ElasticSearch</h2>
<p>Note that you must install ElasticSearch version 7.</p>
<pre><code class="language-sh">export JAVA_HOME=/usr/lib/jvm/default-java
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
sudo add-apt-repository &quot;deb https://artifacts.elastic.co/packages/7.x/apt stable main&quot;
sudo apt-get update
sudo apt-get install elasticsearch
sudo systemctl enable elasticsearch
sudo systemctl start elasticsearch
</code></pre>
<h2 id="6-prepare-database">6. Prepare database</h2>
<p>While the digitisation data is stored in files on the data staging point, the data for system processes (projects, employees, progress of objects in the workflow, etc.) is stored in a database. You need to create a database on the MySQL server and configure access for Production.</p>
<pre><code class="language-sql">sudo mysql
create database kitodo;
create user 'kitodo'@'localhost' identified by 'kitodo';
grant all on kitodo.* to 'kitodo'@'localhost';
exit;
</code></pre>
<p>Then download the database content template and load it into the database:</p>
<pre><code class="language-sh">wget https://github.com/kitodo/kitodo-production/releases/download/kitodo-production-3.4.0/kitodo_3-4-0.sql
mysql -u kitodo -pkitodo -D kitodo &lt; kitodo_3-4-0.sql
</code></pre>
<p>The following errors currently have to be corrected manually during an installation:</p>
<p>Schema-validation: missing table [client_x_listColumn] https://github.com/kitodo/kitodo-production/issues/3998</p>
<p>Flyway migration is failing https://github.com/kitodo/kitodo-production/issues/3810</p>
<h2 id="7-prepare-ldap-for-samba">7. Prepare LDAP for Samba</h2>
<p>Load the Samba-Schema into LDAP:</p>
<pre><code>wget https://raw.githubusercontent.com/zentyal/samba/master/examples/LDAP/samba.ldif
cat samba.ldif | sudo ldapadd -Q -Y EXTERNAL -H  ldapi:///
</code></pre>
<p>Create an entry in the LDAP for the group of production users. To do this, create a file users.ldifwith the following content:</p>
<pre><code class="language-ldif">dn: ou=users,dc=nodomain
objectClass: organizationalUnit
ou: users
</code></pre>
<p>Load the file into LDAP with:</p>
<pre><code>ldapadd -x -D cn=admin,dc=nodomain -w 'LDAP-Admin-Passwort' &lt; users.ldif
</code></pre>
<p>Determine the group number for all users:</p>
<pre><code>grep users /etc/group
</code></pre>
<p>It is the number between the second and third colon. (Most of the time this is 100.)</p>
<p>Determine the highest assigned user number. For this, look at the file <code>/etc/passwd</code>.</p>
<pre><code>less /etc/passwd
</code></pre>
<p>Each row corresponds to a user account. The user number is between the second and third colon (the first of the two numbers). All users who are not system accounts have a user number from 1000 upwards. Find the first number greater than 1000 that <em>no longer</em> occurs. This is the next <em>free</em> user number. End the display by pressing the button <kbd>Q</kbd>.</p>
<p>Create a file <code>nextfreeunixid.ldif</code> with the following content. Enter the information you found:</p>
<pre><code class="language-ldif">dn: cn=NextFreeUnixId,dc=nodomain
objectClass: inetOrgPerson
sn: NextFreeUnixId
objectClass: posixAccount
cn: NextFreeUnixId
uid: nextfreeunixid
uidNumber: #die nächste freie Benutzendennummer#
gidNumber: #die ermittelte Gruppennummer#
homeDirectory: /dev/null
</code></pre>
<p>Load the file into LDAP with:</p>
<pre><code>ldapadd -x -D cn=admin,dc=nodomain -w 'LDAP-Admin-Passwort' &lt; nextfreeunixid.ldif
</code></pre>
<h2 id="8-samba-configuration">8. Samba configuration</h2>
<p>Edit the file <code>/etc/samba/smb.conf</code> so that it contains the following:</p>
<pre><code class="language-smb.conf">[global]
workgroup = KITODO
unix extensions = no
wide links = yes
load printers = no
security = user
invalid users = root
encrypt passwords = yes

ntlm auth = yes
lanman auth = no
client ntlmv2 auth = yes

passdb backend = ldapsam:ldap://127.0.0.1
ldap suffix = dc=nodomain
ldap user suffix = ou=users
ldap group suffix = ou=groups
ldap admin dn = cn=admin,dc=nodomain
ldap ssl = no
ldap passwd sync = yes
ldap delete dn = no

[homes]
comment = Home Directories
path = /usr/local/kitodo/users/%U
read only = no
browseable = no
valid users = %S
guest ok = no
inherit permissions = yes
</code></pre>
<p>Edit the Name Service Switch config file <code>/etc/nsswitch.conf:</code> Add the argument <code>ldap:</code> to the <code>passwd:</code> line.</p>
<pre><code>passwd:         compat systemd ldap
</code></pre>
<p>In Samba, set the LDAP-Password:</p>
<pre><code>sudo smbpasswd -w 'LDAP-Admin-Password'
</code></pre>
<p>Restart the Samba services:</p>
<pre><code>sudo systemctl restart smbd nmbd
</code></pre>
<h2 id="9-create-program-folders-and-files">9. Create program folders and files</h2>
<p>Download the software, modules and configuration files, create a program folder, unzip the modules and configuration files. Place the metadata folder on the data partition. Assign the necessary permissions:</p>
<pre><code class="language-sh">wget https://github.com/kitodo/kitodo-production/releases/download/kitodo-production-3.4.0/kitodo-3.4.0.war
wget https://github.com/kitodo/kitodo-production/releases/download/kitodo-production-3.4.0/kitodo_3-4-0_config_modules.zip

sudo unzip kitodo_3-4-0_config_modules.zip -x kitodo_3-4_config_modules/scripts/*.bat -d /usr/local
sudo mv /usr/local/kitodo_3-4_config_modules /usr/local/kitodo
sudo mkdir /usr/local/kitodo/messages
sudo unzip -j kitodo-3.4-0.war 'WEB-INF/classes/messages/*' -d /usr/local/kitodo/messages
cd /usr/local/kitodo
sudo mv metadata /mnt/data
sudo ln -s /mnt/data/metadata
sudo mkdir logs temp
# sudo chown -R ‹Admin-User›:users config messages rulesets xslt #optional
sudo chown -R tomcat9:tomcat9 diagrams logs metadata temp users
</code></pre>
<h2 id="10-configure-scripts">10. Configure scripts</h2>
<pre><code>sudo dos2unix scripts/*.sh
sudo chown tomcat9 scripts/*.sh
sudo chmod 544 scripts/*.sh
cd
</code></pre>
<p>Edit the file <code>/usr/local/kitodo/scripts/script_createDirUserHome.sh</code> as follows:</p>
<pre><code class="language-sh">#!/bin/sh
User=&quot;$1&quot;
Home=&quot;$2&quot;

/bin/mkdir &quot;$Home&quot;
/bin/chmod g+w &quot;$Home&quot;
sudo /bin/chown $User &quot;$Home&quot;
sudo /bin/chgrp tomcat9 &quot;$Home&quot;
</code></pre>
<p>Edit the file <code>sudo nano /usr/local/kitodo/scripts/script_createSymLink.sh</code> as follows:</p>
<pre><code class="language-sh">#!/bin/sh
Source=&quot;$1&quot;
Target=&quot;$2&quot;
User=&quot;$3&quot;

/bin/ln -s &quot;$Source&quot; &quot;$Target&quot;
sudo /bin/chown -R $User &quot;$Source&quot;
</code></pre>
<p>Create a file with the command <code>sudo visudo -f /etc/sudoers.d/kitodo</code> and the following content:</p>
<pre><code class="language-sudoers">User_Alias TOMCAT_USER = tomcat9

Cmnd_Alias CHOWN_METADATA = /bin/chown -R * /usr/local/kitodo/metadata/*
Cmnd_Alias CHOWN_USERS = /bin/chown * /usr/local/kitodo/users/*
Cmnd_Alias CHGRP_USERS = /bin/chgrp tomcat9 /usr/local/kitodo/users/*

TOMCAT_USER ALL=NOPASSWD: CHOWN_METADATA, CHOWN_USERS, CHGRP_USERS
</code></pre>
<h2 id="11-configure-tomcat">11. Configure Tomcat</h2>
<p>Adjust the default Tomcat settings, <code>/etc/default/tomcat9</code>:
Add the following <code>JAVA_OPTS</code> line in order to give Tomcat more RAM (4G, of which 256m for the program code):</p>
<pre><code>JAVA_OPTS="-Djava.awt.headless=true -XX:+UseConcMarkSweepGC -Xmx4G -XX:MaxPermSize=256m"
</code></pre>
<p>When running <code>systemd</code> in <code>full</code> or <code>strict</code> <code>ProtectSystem</code> mode (newer Linux distributions), write access to the directory hierarchy must be enabled under <code>/usr/local/kitodo/</code> by adding the line <code>ReadWritePaths=/usr/local/kitodo/ReadWritePaths=</code> to the file <code>/lib/systemd/system/tomcat9.service</code> in the <code>[Service]</code> section. (Repeat the line for each shared path.)</p>
<p>After that, restart Tomcat:</p>
<pre><code>sudo systemctl daemon-reload
sudo service tomcat9 restart
</code></pre>
<p>Install the web application:</p>
<pre><code>sudo cp kitodo-3.4.0.war /var/lib/tomcat9/webapps/kitodo##3.4.0.war
</code></pre>
<h2 id="12-configure-log-rotation">12. Configure log rotation</h2>
<p>Create the file <code>/etc/logrotate.d/kitodo</code> eg with the following contents:</p>
<pre><code class="language-logrotate">/usr/local/kitodo/logs/kitodo.log {
    copytruncate
    daily
    rotate 7
    ifempty
    compress
    compresscmd /usr/bin/gzip
    uncompresscmd /usr/bin/gunzip
    missingok
    nomail
 }
</code></pre>
<h2 id="13-configuration-in-the-front-end">13. Configuration in the front end</h2>
<p>You can reach the web application in a browser at the address: <code>http://</code><em>host</em><code>:8080/kitodo</code>. Sign in with the username <code>testadmin</code> and password <code>test</code>.</p>
<h3 id="13a-build-the-search-index">13a) Build the search index</h3>
<p>The System-Indexing page will open. Generate the ElasticSearch Mapping and fully index the whole index.</p>
<h3 id="13b-configure-ldap">13b) Configure LDAP</h3>
<p>Then switch to Users via the main menu which you'll find by clicking the Rubik's cube icon, top right. Create a new LDAP server with the following settings using the “New” button:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Manager login</td>
<td><code>cn=admin,dc=nodomain</code></td>
</tr>
<tr>
<td>nextFreeUnixIdPattern</td>
<td><code>cn=NextFreeUnixId,dc=nodomain</code></td>
</tr>
<tr>
<td>URL</td>
<td><code>ldap://localhost:389/</code></td>
</tr>
<tr>
<td>Manager password</td>
<td><em>LDAP-Admin-Passwort</em></td>
</tr>
</tbody>
</table>
<p>Switch to the LDAP Groups tab. Find out the Secure Identifier (SID) with the command:</p>
<pre><code>sudo net getlocalsid
</code></pre>
<p>Adjust the LDAP group settings as follows:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>User DN</td>
<td><code>cn={login},ou=users,dc=nodomain</code></td>
<td><code>cn={login},ou=users,dc=nodomain</code></td>
</tr>
<tr>
<td>gidNumber</td>
<td><em>Group number</em></td>
<td><code>100</code></td>
</tr>
<tr>
<td>sambaSID</td>
<td><em>SID</em><code>-{uidnumber*2+1001}</code></td>
<td><code>S-1-5-21-123456789-1234567890-1234567890-{uidnumber*2+1001}</code></td>
</tr>
<tr>
<td>LDAP-Server</td>
<td><em>select the server you just created</em></td>
<td>Local LDAP Server</td>
</tr>
<tr>
<td>loginShell</td>
<td><code>/bin/false</code></td>
<td><code>/bin/false</code></td>
</tr>
<tr>
<td>sambaPrimaryGruopSID</td>
<td><em>SID</em><code>-1000</code></td>
<td><code>S-1-5-21-123456789-1234567890-1234567890-1000</code></td>
</tr>
</tbody>
</table>
<p>Further down on the LDAP Groups tab, enable LDAP authentication. Then go to the Users page – Users and edit the users one by one. Write the LDAP configuration for each user.</p>
<p>Adjust the configuration of the web application under <code>/var/lib/tomcat9/webapps/kitodo##3.2/WEB-INF/classes/kitodo_config.properties</code>: Change the line <code>ldap_use</code> to the value <code>true</code>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>